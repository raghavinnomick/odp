<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ODP Bot Sequence Diagram</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f1b33;
      --card:#111f3d;
      --muted:#9fb3c8;
      --text:#eaf2ff;
      --line:rgba(255,255,255,.12);
      --accent:#5eead4;
      --accent2:#60a5fa;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#34d399;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background: radial-gradient(1200px 600px at 20% 0%, #13234a 0%, var(--bg) 55%) fixed;
      padding: 28px;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
    }

    .header{
      display:flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title{
      display:flex;
      flex-direction: column;
      gap: 6px;
    }

    h1{
      margin:0;
      font-size: 22px;
      letter-spacing: .2px;
    }

    .subtitle{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 760px;
    }

    .badges{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .badge{
      font-size: 12px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space: nowrap;
    }

    .badge b{ color: var(--text); font-weight: 700; }

    .board{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    /* Swimlanes header */
    .lanes{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 0;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    .lane{
      padding: 14px 12px;
      border-right: 1px solid var(--line);
      text-align:center;
    }
    .lane:last-child{ border-right: none; }

    .lane .name{
      font-weight: 800;
      font-size: 13px;
      letter-spacing: .3px;
    }
    .lane .desc{
      margin-top: 5px;
      font-size: 12px;
      color: var(--muted);
    }

    /* Timeline */
    .timeline{
      display:flex;
      flex-direction: column;
      gap: 12px;
      padding: 18px;
    }

    .row{
      position: relative;
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      align-items: center;
    }

    /* Message card placed in a column */
    .msg{
      grid-column: var(--col);
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,.20);
    }

    .msg .top{
      display:flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 6px;
    }

    .tag{
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,.88);
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.16);
      white-space: nowrap;
    }

    .stepno{
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
    }

    .msg .text{
      font-size: 13px;
      line-height: 1.35;
      color: rgba(255,255,255,.92);
    }

    /* Arrows: draw a line from from-col to to-col within the same row */
    .arrow{
      position:absolute;
      top: 50%;
      left: calc((var(--from) - 1) * 20%);
      width: calc((var(--to) - var(--from)) * 20%);
      height: 0;
      border-top: 2px solid rgba(255,255,255,.25);
      transform: translateY(-50%);
    }

    .arrow::after{
      content:"";
      position:absolute;
      right: -1px;
      top: -5px;
      border-width: 6px 0 6px 10px;
      border-style: solid;
      border-color: transparent transparent transparent rgba(255,255,255,.25);
    }

    /* Reverse arrow (right-to-left) */
    .arrow.rev{
      left: calc((var(--to) - 1) * 20%);
      width: calc((var(--from) - var(--to)) * 20%);
    }
    .arrow.rev::after{
      left: -1px;
      right: auto;
      transform: rotate(180deg);
    }

    /* Color themes per step type */
    .msg.accent { border-color: rgba(94,234,212,.35); background: rgba(94,234,212,.08); }
    .msg.blue   { border-color: rgba(96,165,250,.35); background: rgba(96,165,250,.08); }
    .msg.ok     { border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.08); }
    .msg.warn   { border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.08); }
    .msg.danger { border-color: rgba(251,113,133,.35); background: rgba(251,113,133,.08); }

    /* Decision blocks */
    .decision{
      margin: 6px 0 2px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.28);
      background: rgba(255,255,255,.03);
      padding: 12px 12px 10px;
    }
    .decision .title{
      font-weight: 800;
      font-size: 13px;
      margin: 0 0 8px;
      color: rgba(255,255,255,.94);
      display:flex;
      align-items:center;
      gap: 8px;
    }
    .decision .title .dot{
      width: 10px; height: 10px; border-radius: 999px;
      background: var(--warn);
      box-shadow: 0 0 0 4px rgba(251,191,36,.15);
    }
    .decision .grid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      align-items: stretch;
    }
    .decision .mini{
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.12);
      padding: 10px 12px;
      font-size: 12px;
      color: rgba(255,255,255,.90);
      line-height: 1.35;
    }
    .decision .mini b{ color: var(--text); }

    .foot{
      margin-top: 12px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.4;
    }
    .foot code{
      font-family: var(--mono);
      font-size: 11px;
      padding: 2px 6px;
      border: 1px solid var(--line);
      border-radius: 8px;
      background: rgba(0,0,0,.18);
      color: rgba(255,255,255,.9);
    }

    @media (max-width: 980px){
      .lanes{ grid-template-columns: 1fr; }
      .lane{ border-right: none; border-bottom: 1px solid var(--line); text-align:left; }
      .timeline{ padding: 14px; }
      .row{ grid-template-columns: 1fr; }
      .msg{ grid-column: auto !important; }
      .arrow{ display:none; }
      .decision .grid{ grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="title">
        <h1>ODP Bot — KB Grounded Reply Sequence</h1>
        <div class="subtitle">
          This flow ensures: <b>Answer only from approved KB</b>, <b>Clarify-first</b> when missing, and <b>No invented deal terms</b>.
          (Works as RAG: Retrieve from KB → Generate reply using retrieved content only.)
        </div>
      </div>
      <div class="badges">
        <div class="badge"><b>Mode:</b> Request/Response API</div>
        <div class="badge"><b>KB:</b> PostgreSQL (Deals/FAQs/Rules)</div>
        <div class="badge"><b>Guardrail:</b> Clarify / Not-in-KB</div>
      </div>
    </div>

    <div class="board">
      <div class="lanes">
        <div class="lane">
          <div class="name">Investor / User</div>
          <div class="desc">Asks question</div>
        </div>
        <div class="lane">
          <div class="name">Bot UI</div>
          <div class="desc">Chat / form</div>
        </div>
        <div class="lane">
          <div class="name">Bot Service</div>
          <div class="desc">Intent + rules</div>
        </div>
        <div class="lane">
          <div class="name">Knowledge Base</div>
          <div class="desc">Deals / FAQs</div>
        </div>
        <div class="lane">
          <div class="name">LLM Draft Engine</div>
          <div class="desc">Founder draft</div>
        </div>
      </div>

      <div class="timeline">

        <!-- Step 1 -->
        <div class="row">
          <div class="arrow" style="--from:1; --to:2;"></div>
          <div class="msg accent" style="--col:1;">
            <div class="top">
              <span class="tag">Ask</span><span class="stepno">Step 1</span>
            </div>
            <div class="text"><b>User</b> asks a question (single or multiple).</div>
          </div>
          <div class="msg accent" style="--col:2;">
            <div class="top">
              <span class="tag">Receive</span><span class="stepno">UI</span>
            </div>
            <div class="text">UI captures input text.</div>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="row">
          <div class="arrow" style="--from:2; --to:3;"></div>
          <div class="msg blue" style="--col:2;">
            <div class="top">
              <span class="tag">Send</span><span class="stepno">Step 2</span>
            </div>
            <div class="text"><b>UI → Bot</b> sends the question text.</div>
          </div>
          <div class="msg blue" style="--col:3;">
            <div class="top">
              <span class="tag">Pre-process</span><span class="stepno">Bot</span>
            </div>
            <div class="text">Clean text, split multiple questions, classify intent.</div>
          </div>
        </div>

        <!-- Step 3: Deal detection -->
        <div class="row">
          <div class="arrow" style="--from:3; --to:4;"></div>
          <div class="msg" style="--col:3;">
            <div class="top">
              <span class="tag">Deal detection</span><span class="stepno">Step 3</span>
            </div>
            <div class="text"><b>Bot → KB</b> match deal names + aliases.</div>
          </div>
          <div class="msg" style="--col:4;">
            <div class="top">
              <span class="tag">Result</span><span class="stepno">KB</span>
            </div>
            <div class="text">Return <code>deal_id</code> + confidence / matches list.</div>
          </div>
        </div>

        <!-- Decision: deal unclear -->
        <div class="decision">
          <div class="title"><span class="dot"></span>Decision: Deal unclear or multiple matches</div>
          <div class="grid">
            <div class="mini"><b>Bot → UI:</b> Ask “Which deal are you referring to?” and show options.</div>
            <div class="mini"><b>User → UI:</b> Select / confirm the deal.</div>
            <div class="mini"><b>UI → Bot:</b> Send selected <code>deal_id</code>.</div>
            <div class="mini"><b>Rule:</b> If not confident, bot must ask (no guessing).</div>
            <div class="mini"><b>Output:</b> Deal is now locked for retrieval.</div>
          </div>
        </div>

        <!-- Step 4: Retrieval -->
        <div class="row">
          <div class="arrow" style="--from:3; --to:4;"></div>
          <div class="msg ok" style="--col:3;">
            <div class="top">
              <span class="tag">Retrieve KB</span><span class="stepno">Step 4</span>
            </div>
            <div class="text"><b>Bot → KB</b> fetch Deal fields + matching FAQs + tone rules.</div>
          </div>
          <div class="msg ok" style="--col:4;">
            <div class="top">
              <span class="tag">KB data</span><span class="stepno">KB</span>
            </div>
            <div class="text">Return approved content + missing/conflict flags.</div>
          </div>
        </div>

        <!-- Decision: missing/conflict -->
        <div class="decision">
          <div class="title"><span class="dot"></span>Decision: KB missing / unclear / conflicting</div>
          <div class="grid">
            <div class="mini"><b>Bot → UI:</b> Ask 1–3 clarifying questions (only what is needed).</div>
            <div class="mini"><b>User → UI:</b> Provide answers.</div>
            <div class="mini"><b>UI → Bot:</b> Send clarifications.</div>
            <div class="mini"><b>Bot → KB:</b> Re-retrieve using clarified details.</div>
            <div class="mini"><b>Rule:</b> Missing fact ⇒ clarify (never invent terms).</div>
          </div>
        </div>

        <!-- Step 5: Generate -->
        <div class="row">
          <div class="arrow" style="--from:3; --to:5;"></div>
          <div class="msg blue" style="--col:3;">
            <div class="top">
              <span class="tag">Generate</span><span class="stepno">Step 5</span>
            </div>
            <div class="text"><b>Bot → LLM</b> send retrieved KB + tone rules only.</div>
          </div>
          <div class="msg blue" style="--col:5;">
            <div class="top">
              <span class="tag">Draft reply</span><span class="stepno">LLM</span>
            </div>
            <div class="text">Return founder-tone draft reply (KB-grounded).</div>
          </div>
        </div>

        <!-- Step 6: Safety check + respond -->
        <div class="row">
          <div class="arrow rev" style="--from:5; --to:3;"></div>
          <div class="msg" style="--col:3;">
            <div class="top">
              <span class="tag">Safety check</span><span class="stepno">Step 6</span>
            </div>
            <div class="text">Ensure every number/term exists in retrieved KB. If not → clarify/not-in-KB.</div>
          </div>
          <div class="arrow" style="--from:3; --to:2;"></div>
          <div class="msg accent" style="--col:2;">
            <div class="top">
              <span class="tag">Show output</span><span class="stepno">UI</span>
            </div>
            <div class="text">Show final reply or clarifying question to user.</div>
          </div>
        </div>

        <!-- Decision: still not in KB -->
        <div class="decision">
          <div class="title"><span class="dot" style="background: var(--da
